<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secret Cipher</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --glass-bg: rgba(255,255,255,0.82);
    --muted:#566876;
    --gold1:#fff0d1;
    --gold2:#ffbf4d;
    --accent: linear-gradient(90deg,var(--gold1),var(--gold2));
    --radius:12px;
    --shadow: 0 12px 30px rgba(18,24,40,0.06);
    --glass-border: rgba(255,255,255,0.6);
    --text: #071827;
  }
  html,body{height:100%;margin:0;font-family:Poppins,Arial; background: linear-gradient(180deg,#f7fafc,#eef2f7); color:var(--text); -webkit-font-smoothing:antialiased}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;position:sticky;top:0;background:transparent;z-index:40}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--gold1),var(--gold2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#123}
  nav{display:flex;gap:10px;align-items:center}
  nav button{background:transparent;border:0;padding:8px 12px;border-radius:10px;font-weight:600;color:var(--muted);cursor:pointer;transition:.18s}
  nav button.active{color:var(--text);box-shadow:0 8px 30px rgba(255,190,60,0.12);transform:translateY(-2px)}
  nav button.locked{opacity:.5;cursor:not-allowed}
  .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
  .grid{display:grid;gap:18px}
  @media(min-width:920px){ .grid{grid-template-columns:380px 1fr} }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.78));
    border-radius:var(--radius);
    padding:18px;
    border:1px solid var(--glass-border);
    box-shadow:var(--shadow);
    backdrop-filter: blur(8px);
    transition: all .28s ease;
    position:relative;
    overflow:hidden;
  }
  h2{margin:0 0 8px 0;font-family:Orbitron;color:#123}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(10,20,30,0.04);background:transparent;color:var(--text);font-size:15px}
  textarea{min-height:140px}
  input:focus,textarea:focus,select:focus{outline:none;box-shadow:0 8px 30px rgba(18,24,40,0.06);border-color:rgba(0,0,0,0.06)}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;transition:all .18s;font-size:14px}
  .btn.gold{background:var(--accent);color:#123;box-shadow:0 12px 28px rgba(255,190,60,0.14)}
  .btn.gold:hover{transform:translateY(-3px);box-shadow:0 24px 40px rgba(255,190,60,0.2)}
  .btn.ghost{background:transparent;border:1px solid rgba(10,20,30,0.04);color:var(--muted)}
  .btn.small{padding:6px 10px;font-size:13px}
  .btn.full{width:100%;padding:10px 12px}

  .btn.google{background:#fff;border:1px solid rgba(0,0,0,0.04);color:#222;padding:8px 10px}

  .history{max-height:220px;overflow:auto;border-radius:10px;padding:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));border:1px solid rgba(0,0,0,0.02);margin-top:12px}
  .history-item{padding:8px;border-bottom:1px dashed rgba(0,0,0,0.04);font-size:14px;color:var(--muted)}

  #toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#0d1b22;color:#fff;padding:10px 16px;border-radius:16px;box-shadow:0 10px 30px rgba(2,8,23,0.5);opacity:0;pointer-events:none;transition:all .18s}
  #toast.show{opacity:1;pointer-events:auto;transform:translate(-50%,-6px)}

  #confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:5000}

  section[aria-hidden="true"]{opacity:0;transform:translateY(8px) scale(.998);pointer-events:none}
  section[aria-hidden="false"]{opacity:1;transform:none;pointer-events:auto;transition:all .28s ease}

  .welcomeOverlay{
    position:fixed;left:50%;top:22%;transform:translateX(-50%);background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.9));padding:22px 26px;border-radius:14px;box-shadow:0 18px 40px rgba(12,18,25,0.12);z-index:600;display:flex;flex-direction:column;align-items:center;gap:8px;opacity:0;pointer-events:none;transition:all .28s;
  }
  .welcomeOverlay.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(0)}
  .welcomeOverlay h3{margin:0;font-family:Orbitron;color:#123}

  @media(max-width:760px){ .grid{grid-template-columns:1fr} .brand .kv{display:none} .logo{width:40px;height:40px} }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">SC</div>
    <div>
      <div style="font-weight:700">Secret Cipher</div>
    
    </div>
  </div>

  <div style="display:flex;gap:12px;align-items:center">
    <nav aria-label="main-nav">
      <button id="nav-login" onclick="navTo('login')" class="active">Login</button>
      <button id="nav-cipher" onclick="navTo('cipher')" class="locked">Cipher</button>
      <button id="nav-quiz" onclick="navTo('quiz')" class="locked">Quiz</button>
    </nav>
    <div id="userBadge" style="font-size:13px;color:var(--muted);margin-left:8px">Not signed</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- Login card -->
    <section id="login" aria-hidden="false" class="card">
      <h2>üîê Login / Sign Up</h2>
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email">

      <label for="password">Password</label>
      <div style="position:relative">
        <input id="password" type="password" placeholder="Password" autocomplete="current-password">
        <button id="pwdToggle" style="position:absolute;right:10px;top:10px;border:0;background:transparent;cursor:pointer;color:var(--muted)">üëÅ</button>
      </div>

      <div class="row">
        <button id="btnSignup" class="btn gold small">Sign Up</button>
        <button id="btnLogin" class="btn gold small">Login</button>
        <button id="btnLogout" class="btn ghost small">Logout</button>
      </div>

      <div class="row">
        <button id="btnGoogle" class="btn google small"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="height:16px" alt=""> Continue with Google</button>
        <input id="resetEmail" type="email" placeholder="Reset email (optional)">
        <button id="btnReset" class="btn ghost small">Reset</button>
      </div>

      <p id="userStatus" style="margin-top:12px;color:var(--muted)">Not logged in</p>
    </section>

    <!-- Right column: Cipher + Quiz -->
    <div>
      <!-- Cipher -->
      <section id="cipher" aria-hidden="true" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>üìù Cipher</h2>
          <div style="display:flex;gap:10px;align-items:center">
            <div id="modeLabel" class="kv">Mode: Vowel-number</div>
            <button id="logoutTop" class="btn ghost small">Logout</button>
          </div>
        </div>

        <label for="cipherInput">Message</label>
        <textarea id="cipherInput" placeholder="Type or paste text..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <div class="kv"><span id="charCount">0</span> chars</div>
          <div class="kv">Autosave on</div>
        </div>

        <div class="row" role="group" aria-label="cipher-actions" style="margin-top:12px">
          <button id="btnEncode" class="btn gold small">üîí Encode</button>
          <button id="btnDecode" class="btn gold small">üîë Decode</button>
          <button id="btnSmart" class="btn gold small">ü§ñ Smart Detect</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnCopy" class="btn small">üìã Copy</button>
          <button id="btnClear" class="btn ghost small">üßπ Clear</button>
          <button id="btnExport" class="btn ghost small">Export</button>
          <label class="btn ghost small" style="cursor:pointer">Import<input id="importFile" type="file" accept="application/json" style="display:none"></label>
        </div>

        <label for="cipherOutput" style="margin-top:12px">Result</label>
        <textarea id="cipherOutput" readonly placeholder="Result will appear here..."></textarea>

        <h4 style="margin-top:12px">üìú History</h4>
        <div id="history" class="history"></div>
      </section>

      <!-- Quiz -->
      <section id="quiz" aria-hidden="true" class="card" style="margin-top:18px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>üß† Quiz</h2>
          <div style="display:flex;gap:10px;align-items:center">
            <div id="quizTimerWrap" class="kv">Time left: <span id="quizTimer">0</span>s</div>
            <button id="logoutQuiz" class="btn ghost small">Logout</button>
          </div>
        </div>

        <div id="quizArea" style="margin-top:12px">
          <div id="quizQuestion" style="font-weight:600;margin-bottom:8px;color:#123">Press Start to begin</div>
          <input id="quizAnswer" type="text" placeholder="Type decoded answer">

          <div class="row" style="margin-top:10px">
            <button id="btnStartQuiz" class="btn gold small">Start</button>
            <button id="btnSubmit" class="btn small">Submit</button>
            <button id="btnNext" class="btn ghost small">Next</button>
            <button id="btnEndQuiz" class="btn ghost small">End</button>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
            <div class="kv">Progress: <span id="quizProgress">0</span>/<span id="quizTotal">0</span></div>
            <div class="kv">Score: <span id="quizScore">0</span></div>
          </div>

          <div style="margin-top:12px">
            <button id="btnSaveScore" class="btn small">Save Score</button>
            <button id="btnShareScore" class="btn small">Share Score</button>
          </div>

          <h4 style="margin-top:14px">üèÜ Leaderboard</h4>
          <div id="leaderboard" class="history"></div>
        </div>
      </section>
    </div>
  </div>
</main>

<!-- Welcome overlay -->
<div id="welcome" class="welcomeOverlay" role="dialog" aria-modal="true" style="display:none">
  <h3 id="welcomeText">‚ú® Welcome back!</h3>
  <div id="welcomeSub" class="kv" style="color:var(--muted)">Redirecting you to the Cipher...</div>
</div>

<!-- toast + confetti -->
<div id="toast" role="status" aria-live="polite"></div>
<canvas id="confetti"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // REPLACE with your config to enable Firestore persistence
  const firebaseConfig = {
    apiKey: "AIzaSyBOfDcEpw-p7DNuoUKqlGlTC782yiVdf00",
    authDomain: "cipher-e6c22.firebaseapp.com",
    projectId: "cipher-e6c22",
    storageBucket: "cipher-e6c22.appspot.com",
    messagingSenderId: "345358817477",
    appId: "1:345358817477:web:7ba4dd380d634b559038ac"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  const $ = id => document.getElementById(id);
  const toastEl = $('toast');
  function toast(msg, ms=1400){ if(!toastEl) return; toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }

  // confetti
  const confetti = $('confetti'); const ctx = confetti.getContext?.('2d');
  function burstConfetti(){
    if(!ctx) return;
    confetti.width = window.innerWidth; confetti.height = window.innerHeight;
    const pieces=[]; for(let i=0;i<60;i++){ pieces.push({ x: Math.random()*confetti.width, y: -20-Math.random()*200, vx: (Math.random()-0.5)*6, vy: Math.random()*6+2, r: Math.random()*6+4, c: ['#ffd86b','#ffb84a','#ffeecf','#ffdca6'][Math.floor(Math.random()*4)] }); }
    let t=0; function frame(){ ctx.clearRect(0,0,confetti.width,confetti.height); for(const p of pieces){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; ctx.fillStyle=p.c; ctx.beginPath(); ctx.ellipse(p.x,p.y,p.r,p.r*0.7,0,0,Math.PI*2); ctx.fill(); } t++; if(t<120) requestAnimationFrame(frame); else ctx.clearRect(0,0,confetti.width,confetti.height); } frame();
  }

  // cipher mapping (vowel->number, consonant + 'a')
  const vmap = { a:"1", e:"2", i:"3", o:"4", u:"5" };
  const rev = { "1":"a","2":"e","3":"i","4":"o","5":"u" };
  function encodeCipher(s){ let out=''; for(const c of s){ const l=c.toLowerCase(); if(vmap[l]) out+=vmap[l]; else if(/[a-z]/i.test(c)) out+=c+'a'; else out+=c; } return out; }
  function decodeCipher(s){ let out=''; for(let i=0;i<s.length;i++){ const c=s[i]; if(rev[c]) out+=rev[c]; else if(/[a-z]/i.test(c) && s[i+1]==='a'){ out+=c; i++; } else out+=c; } return out; }

  // local history
  function pushLocalHistory(item){ const arr=JSON.parse(localStorage.getItem('sc_history')||'[]'); arr.unshift(item); localStorage.setItem('sc_history', JSON.stringify(arr.slice(0,500))); renderHistory(); }
  function renderHistory(){ const arr=JSON.parse(localStorage.getItem('sc_history')||'[]'); const el=$('history'); if(!el) return; if(!arr.length){ el.innerHTML = '<div class="history-item" style="color:var(--muted)">No history yet</div>'; return; } el.innerHTML = arr.map(it=>`<div class="history-item"><strong>${it.type}</strong><div style="float:right;color:var(--muted)">${new Date(it.time).toLocaleString()}</div><div style="clear:both;margin-top:6px;white-space:pre-wrap">${escapeHtml(it.res)}</div></div>`).join(''); }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // encode/decode UI functions
  function runEncode(){ const src=$('cipherInput').value||''; const out=encodeCipher(src); $('cipherOutput').value=out; pushLocalHistory({ type:'Encoded', res:out, time:new Date().toISOString() }); if(auth.currentUser) saveHistoryFirestore('Encoded', out); toast('Encoded ‚úì'); }
  function runDecode(){ const src=$('cipherInput').value||''; const out=decodeCipher(src); $('cipherOutput').value=out; pushLocalHistory({ type:'Decoded', res:out, time:new Date().toISOString() }); if(auth.currentUser) saveHistoryFirestore('Decoded', out); toast('Decoded ‚úì'); }
  function runSmart(){ const v=$('cipherInput').value||''; if(/[1-5]/.test(v)) runDecode(); else runEncode(); }
  function saveHistoryFirestore(type, res){ try{ const u=auth.currentUser; if(!u) return; addDoc(collection(db, 'users', u.uid, 'history'), { type, res, createdAt: Timestamp.now() }).catch(e=>console.warn('save hist', e)); }catch(e){ console.warn(e); } }
  function copyOutput(){ const out=$('cipherOutput').value||''; if(!out){ toast('Nothing to copy'); return; } navigator.clipboard.writeText(out).then(()=>toast('Copied ‚úì')).catch(()=>toast('Copy failed')); }
  function clearCipher(){ if(!confirm('Clear input & output?')) return; $('cipherInput').value=''; $('cipherOutput').value=''; localStorage.removeItem('sc_draft'); $('charCount').textContent='0'; toast('Cleared'); }

  // autosave & charcount
  const DRAFT_KEY='sc_draft';
  $('cipherInput').addEventListener?.('input', (e)=>{ const v=e.target.value||''; $('charCount').textContent=v.length; localStorage.setItem(DRAFT_KEY, v); });
  (function loadDraft(){ const d=localStorage.getItem(DRAFT_KEY); if(d) $('cipherInput').value=d; $('charCount').textContent=($('cipherInput').value||'').length; })();

  // import/export history
  function exportHistory(){ const arr=JSON.parse(localStorage.getItem('sc_history')||'[]'); if(!arr.length){ toast('No history to export'); return; } const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cipher_history.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('Export started'); }
  function handleImport(e){ const f=e.target.files && e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ try{ const arr=JSON.parse(ev.target.result); if(!Array.isArray(arr)) throw new Error('Invalid'); const cur=JSON.parse(localStorage.getItem('sc_history')||'[]'); const merged=[...arr,...cur].slice(0,500); localStorage.setItem('sc_history', JSON.stringify(merged)); renderHistory(); toast('Imported ‚úì'); }catch(err){ console.error(err); toast('Import failed'); } }; r.readAsText(f); }

  // quiz
  const SENTENCES = [
    "The quick brown fox jumps over the lazy dog.",
    "Knowledge is power, but wisdom is everything.",
    "Success usually comes to those who are too busy to be looking for it.",
    "Do not watch the clock. Do what it does. Keep going.",
    "Difficult roads often lead to beautiful destinations.",
    "Hard work beats talent when talent doesn‚Äôt work hard.",
    "Great things never come from comfort zones.",
    "Dream big and dare to fail.",
    "The only limit to our realization of tomorrow is our doubts of today.",
    "Opportunities don't happen, you create them.",
    "If you want something you've never had, you must be willing to do something you've never done.",
    "Life is 10% what happens to us and 90% how we react to it.",
    "It always seems impossible until it's done.",
    "Don't wait. The time will never be just right.",
    "Act as if what you do makes a difference. It does.",
    "The harder you fall, the higher you bounce.",
    "Small steps every day add up to big results over time.",
    "Creativity is intelligence having fun.",
    "Be kind whenever possible. It is always possible.",
    "Change your thoughts and you change your world.",
    "A smooth sea never made a skilled sailor.",
    "The secret of getting ahead is getting started.",
    "Turn your wounds into wisdom and lessons into strength.",
    "Perseverance is not a long race; it is many short races one after another.",
    "Value the people who value you; pay attention to where you spend your time."
  ];

  function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

  let quizPool=[], qi=0, qscore=0, qTimer=null, qTimeLeft=45;
  function startQuiz(){
    if(!auth.currentUser){ toast('Login required'); return; }
    quizPool = shuffle(SENTENCES).slice(0,15).map(s=>({plain:s, encoded:encodeCipher(s)}));
    qi=0; qscore=0; $('quizTotal').textContent=quizPool.length; $('quizScore').textContent=0;
    showQuizQuestion();
    renderLeaderboardLocal();
  }
  function showQuizQuestion(){
    if(qi>=quizPool.length){ finishQuiz(); return; }
    $('quizQuestion').textContent = 'Decode this: ' + quizPool[qi].encoded;
    $('quizAnswer').value='';
    $('quizProgress').textContent = qi+1;
    startQuizTimer();
  }
  function startQuizTimer(){ stopQuizTimer(); qTimeLeft=45; $('quizTimer').textContent=qTimeLeft; qTimer=setInterval(()=>{ qTimeLeft--; $('quizTimer').textContent=qTimeLeft; if(qTimeLeft<=0){ stopQuizTimer(); toast('Time up'); qi++; showQuizQuestion(); } },1000); }
  function stopQuizTimer(){ if(qTimer){ clearInterval(qTimer); qTimer=null; } }
  function submitQuizAnswer(){ stopQuizTimer(); const ans = ($('quizAnswer').value||'').trim().toLowerCase(); if(!ans){ toast('Enter answer'); startQuizTimer(); return; } const correct = quizPool[qi].plain.trim().toLowerCase(); if(ans===correct){ qscore++; toast('Correct ‚úì'); burstConfetti(); } else toast('Wrong ‚Äî '+quizPool[qi].plain); qi++; setTimeout(()=>showQuizQuestion(),700); }
  function nextQuizQuestion(){ stopQuizTimer(); qi++; showQuizQuestion(); }
  function finishQuiz(){ stopQuizTimer(); $('quizQuestion').textContent = `Finished ‚Äî Score: ${qscore}/${quizPool.length}`; $('quizScore').textContent = qscore; pushLocalLeader({ user: auth.currentUser ? (auth.currentUser.email||auth.currentUser.uid) : 'anon', score: qscore, total: quizPool.length, time: new Date().toISOString() }); renderLeaderboardLocal(); if(auth.currentUser) saveScoreFirestore(qscore, quizPool.length); }
  function endQuiz(){ stopQuizTimer(); toast(`Quiz ended ‚Äî ${qscore}/${quizPool.length}`); }

  // leaderboard local & firestore
  function pushLocalLeader(entry){ const arr=JSON.parse(localStorage.getItem('sc_leader')||'[]'); arr.unshift(entry); localStorage.setItem('sc_leader', JSON.stringify(arr.slice(0,200))); }
  function renderLeaderboardLocal(){ const arr=JSON.parse(localStorage.getItem('sc_leader')||'[]'); const el=$('leaderboard'); if(!el) return; if(!arr.length){ el.innerHTML='<div class="history-item" style="color:var(--muted)">No scores yet</div>'; return; } el.innerHTML = arr.slice(0,20).map((it,idx)=>`<div class="history-item"><strong>#${idx+1} ${escapeHtml(it.user)}</strong><div style="float:right;color:var(--muted)">${it.score}/${it.total}</div><div style="clear:both;margin-top:6px">${new Date(it.time).toLocaleString()}</div></div>`).join(''); }
  async function saveScoreFirestore(score,total){ try{ const u=auth.currentUser; if(!u) return; await addDoc(collection(db,'leaderboard'), { user: u.email||u.uid, score, total, createdAt: Timestamp.now() }); toast('Saved to server ‚úì'); }catch(e){ console.warn('save score', e); toast('Saved locally'); } }

  // firestore history save
  async function saveHistoryFirestore(type,res){ try{ const u=auth.currentUser; if(!u) return; await addDoc(collection(db,'users',u.uid,'history'), { type, res, createdAt: Timestamp.now() }); }catch(e){ console.warn(e); } }

  // === Auth flows ===
  async function signup(){ const email=$('email').value.trim(), pw=$('password').value; if(!email||!pw){ toast('Email & password required'); return; } try{ await createUserWithEmailAndPassword(auth,email,pw); toast('Signed up ‚úì'); } catch(e){ console.error(e); toast(e.message||'Sign up failed'); } }
  async function login(){ const email=$('email').value.trim(), pw=$('password').value; if(!email||!pw){ toast('Email & password required'); return; } try{ await signInWithEmailAndPassword(auth,email,pw); toast('Logged in ‚úì'); } catch(e){ console.error(e); toast(e.message||'Login failed'); } }
  async function googleLogin(){ try{ await signInWithPopup(auth, provider); toast('Google sign-in ‚úì'); }catch(e){ console.error(e); toast('Google sign-in failed'); } }
  async function logout(){ try{ await signOut(auth); toast('Logged out'); } catch(e){ console.error(e); toast('Logout failed'); } }
  async function forgotPassword(){ const em=$('resetEmail').value.trim(); if(!em){ toast('Enter email'); return; } try{ await sendPasswordResetEmail(auth, em); toast('Reset email sent'); } catch(e){ console.error(e); toast('Reset failed'); } }

  // reflect auth state and show welcome overlay
  onAuthStateChanged(auth, user=>{
    const badge = $('userBadge'), status=$('userStatus');
    if(user){
      badge.textContent = user.displayName || user.email;
      status.textContent = `Signed in: ${user.email}`;
      unlockNav();
      // show animated welcome overlay then go to cipher
      const welcome = $('welcome'), wText = $('welcomeText'), wSub = $('welcomeSub');
      wText.textContent = `‚ú® Welcome back, ${user.displayName || user.email.split('@')[0]}!`;
      wSub.textContent = 'Taking you to Cipher...';
      welcome.style.display = 'flex';
      setTimeout(()=>{ welcome.classList.add('show'); }, 80);
      setTimeout(()=>{ welcome.classList.remove('show'); setTimeout(()=>welcome.style.display='none',300); navigateTo('cipher'); renderHistory(); renderLeaderboardLocal(); loadRemoteHistory(); loadRemoteLeaderboard(); }, 1600);
    } else {
      badge.textContent = 'Not signed';
      status.textContent = 'Not logged in';
      lockNav();
      navigateTo('login');
      renderHistory();
      renderLeaderboardLocal();
    }
  });

  // nav helpers
  function lockNav(){ ['nav-cipher','nav-quiz'].forEach(id=>{ const b=$(id); if(b) b.classList.add('locked'); }); }
  function unlockNav(){ ['nav-cipher','nav-quiz'].forEach(id=>{ const b=$(id); if(b) b.classList.remove('locked'); }); }
  function navTo(id){
    if(id!=='login' && !auth.currentUser){ toast('Login required'); return; }
    navigateTo(id);
  }
  function navigateTo(id){
    ['login','cipher','quiz'].forEach(s=>{ const el=$(s); if(el) el.setAttribute('aria-hidden', s===id ? 'false' : 'true'); });
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    const navBtn = document.querySelector(`#nav-${id}`);
    if(navBtn) navBtn.classList.add('active');
  }

  // load remote history / leaderboard
  async function loadRemoteHistory(){ try{ const u = auth.currentUser; if(!u) return; const q = query(collection(db,'users',u.uid,'history'), orderBy('createdAt','desc')); const snap = await getDocs(q); const arr=[]; snap.forEach(d=>{ const dat=d.data(); arr.push({ type:dat.type, res:dat.res, time:dat.createdAt?.toDate?.().toISOString() || new Date().toISOString() }); }); if(arr.length){ localStorage.setItem('sc_history', JSON.stringify(arr)); renderHistory(); } }catch(e){ console.warn('load remote hist', e); } }
  async function loadRemoteLeaderboard(){ try{ const q = query(collection(db,'leaderboard'), orderBy('score','desc'), limit(20)); const snap = await getDocs(q); const arr=[]; snap.forEach(d=>{ const dat=d.data(); arr.push({ user:dat.user, score:dat.score, total:dat.total, time:dat.createdAt?.toDate?.().toISOString()||new Date().toISOString() }); }); if(arr.length){ const local = JSON.parse(localStorage.getItem('sc_leader')||'[]'); const merged=[...arr,...local].slice(0,200); localStorage.setItem('sc_leader', JSON.stringify(merged)); renderLeaderboardLocal(); } }catch(e){ console.warn('load remote lb', e); } }

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key==='Enter' && document.activeElement === $('cipherInput')){ e.preventDefault(); runSmart(); } if(e.ctrlKey && e.key.toLowerCase()==='s' && document.activeElement === $('cipherInput')){ e.preventDefault(); exportHistory(); } });

  // share score
  function shareScore(){ const s=$('quizScore').textContent||'0'; const total=$('quizTotal').textContent||'0'; const t=`I scored ${s}/${total} on Secret Cipher Quiz!`; navigator.clipboard.writeText(t).then(()=>toast('Score copied ‚Äî share it!')).catch(()=>toast('Copy failed')); }

  // wire DOM after load
  document.addEventListener('DOMContentLoaded', ()=>{
    // cipher buttons
    $('btnEncode').addEventListener('click', runEncode);
    $('btnDecode').addEventListener('click', runDecode);
    $('btnSmart').addEventListener('click', runSmart);
    $('btnCopy').addEventListener('click', copyOutput);
    $('btnClear').addEventListener('click', clearCipher);
    $('btnExport').addEventListener('click', exportHistory);
    $('importFile').addEventListener('change', handleImport);

    // login
    $('btnSignup').addEventListener('click', signup);
    $('btnLogin').addEventListener('click', login);
    $('btnLogout').addEventListener('click', logout);
    $('logoutTop')?.addEventListener('click', logout);
    $('logoutQuiz')?.addEventListener('click', logout);
    $('btnGoogle').addEventListener('click', googleLogin);
    $('btnReset').addEventListener('click', forgotPassword);
    $('pwdToggle').addEventListener('click', ()=>{ const p=$('password'); p.type = p.type==='password' ? 'text' : 'password'; $('pwdToggle').textContent = p.type==='password' ? 'üëÅ' : 'üôà'; });

    // quiz
    $('btnStartQuiz').addEventListener('click', startQuiz);
    $('btnSubmit').addEventListener('click', submitQuizAnswer);
    $('btnNext').addEventListener('click', nextQuizQuestion);
    $('btnEndQuiz').addEventListener('click', endQuiz);
    $('btnSaveScore').addEventListener('click', ()=>{ pushLocalLeader({ user: auth.currentUser ? (auth.currentUser.email||auth.currentUser.uid) : 'anon', score: qscore, total: quizPool.length, time: new Date().toISOString() }); renderLeaderboardLocal(); toast('Saved locally'); });
    $('btnShareScore').addEventListener('click', shareScore);

    // initial UI
    renderHistory();
    renderLeaderboardLocal();
    navigateTo('login'); // ensure login visible initially
  });

  // expose for debugging
  window.encodeCipher = encodeCipher;
  window.decodeCipher = decodeCipher;
  window.startQuiz = startQuiz;

</script>
</body>
</html>